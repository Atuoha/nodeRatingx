'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../../models/Company"),User=require("../../../models/User"),Rating=require("../../../models/Rating");router.all("/*",(a,d,b)=>{a.app.locals.layout="admin";b()});router.get("/",(a,d)=>{Company.find().then(b=>{d.render("accounts/admin/company/subscribers_company_views",{title:"Admin|Company",companies:b})}).catch(b=>console.log(b))});
router.get("/create/:id",(a,d)=>{a.user||(a.flash("error_msg","Sign in to rate company"),d.redirect("back"));Company.findOne({_id:a.params.id}).then(b=>{d.render("accounts/admin/rating/create",{title:"Rating|Company",company:b})}).catch(b=>console.log(b))});
router.post("/create/:id",(a,d)=>{const b=new Rating;b.rating=a.body.rating;b.review=a.body.review;b.company=a.body.company;b.user=a.user;b.save().then(e=>{Company.findOne({_id:a.params.id}).then(c=>{c.ratingSum+=parseInt(a.body.rating);c.ratingNumber+=1;c.ratingPoints.push(a.body.rating);c.save().then(f=>{d.redirect(`/admin/company/show/${a.body.company}`)}).catch(f=>console.log(f))}).catch(c=>console.log(c))}).catch(e=>console.log(e))});module.exports=router;