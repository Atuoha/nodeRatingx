'use strict';const express=require("express"),app=express(),router=express.Router(),User=require("../../../models/User"),Company=require("../../../models/Company"),faker=require("faker"),fs=require("fs"),bcrypt=require("bcryptjs"),{isEmpty}=require("../../../helpers/upload-helpers"),{adminAuth}=require("../../../helpers/authenticate");router.all("/*",(b,d,a)=>{b.app.locals.layout="admin";a()});
router.get("/",(b,d)=>{User.find().populate("company").then(a=>{d.render("accounts/admin/users",{title:"Admin|Users",users:a})}).catch(a=>console.log(a))});router.get("/edit/:id",(b,d)=>{User.findOne({_id:b.params.id}).populate("company").then(a=>{d.render("accounts/admin/users/edit",{title:"Edit|Employee",employee:a})}).catch(a=>console.log(a))});
router.get("/show/:id",(b,d)=>{User.findOne({_id:b.params.id}).populate("company").then(a=>{d.render("accounts/admin/users/show",{title:a.fullname,employee:a})}).catch(a=>console.log(a))});router.get("/create/:id",(b,d)=>{Company.findOne({_id:b.params.id}).then(a=>{d.render("accounts/admin/users/create",{title:"Create|Employee",company:a})}).catch(a=>console.log(a))});
router.get("/create",(b,d)=>{Company.find().then(a=>{d.render("accounts/admin/users/create",{title:"Create|Employee",companies:a})}).catch(a=>console.log(a))});
router.post("/create",(b,d)=>{User.findOne({email:b.body.email}).then(a=>{if(a)b.flash("error_msg","Email already exists. Try again!"),d.redirect("/admin/users/create");else{a="";if(!isEmpty(b.files)){let f=b.files.file;a=Date.now()+"-"+f.name;f.mv("./public/uploads/"+a,e=>{e&&console.log(e)})}const c=new User;c.fullname=b.body.fullname;c.email=b.body.email;c.position=b.body.position;c.status=b.body.status;c.role=b.body.role;c.company=b.body.company;c.file=a;bcrypt.genSalt(10,(f,e)=>{bcrypt.hash(b.body.password,
e,(k,l)=>{k&&console.log(k);c.password=l;c.save().then(g=>{Company.findOne({user:b.user}).then(h=>{h.employees.push(c);h.save().then(m=>{console.log("Employeed pushed")}).catch(m=>console.log(m))}).catch(h=>console.log(h));"Manager"==b.body.role&&Company.findOne({user:b.user}).then(h=>{h.user.push(c);h.save().then(m=>{console.log("Manager pushed")}).catch(m=>console.log(m))}).catch(h=>console.log(h));b.flash("success_msg","Employee record saved successfully :)");d.redirect("/admin/users")}).catch(g=>
console.log(g))})})}})});router.get("/dummy",(b,d)=>{d.render("accounts/admin/users/dummy",{title:"Admin|Users"})});
router.post("/dummy",(b,d)=>{for(let a=0;a<b.body.number;a++){const c=new User;c.fullname=faker.lorem.word().faker.lorem.word();c.email=faker.internet.email();c.phone="000-000-000-000";bcrypt.genSalt(10,(f,e)=>{bcrypt.hash("secret",e,(k,l)=>{k&&console.log(k);c.password=l;c.save().then(g=>{b.flash("success_msg",`${b.body.number} dummy users has been created :)`);d.redirect("/admin/users")}).catch(g=>console.log(g))})})}});
router.put("/update/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){let f=b.files.file;c=Date.now()+"-"+f.name;f.mv("./public/uploads/"+c,e=>{e&&console.log(e)});""!=a.file&&"default.png"!=a.file&&fs.unlink("./public/uploads/"+a.file,e=>{e&&console.log(e)})}b.body.password?(a.fullname=b.body.fullname,a.email=b.body.email,a.position=b.body.position,a.status=b.body.status,a.role=b.body.role,a.file=c,bcrypt.genSalt(10,(f,e)=>{bcrypt.hash(b.body.password,e,(k,
l)=>{a.password=l;a.save().then(g=>{b.flash("success_msg",`${g.fullname} has been updated successfully`);d.redirect("/admin/users")}).catch(g=>console.log(g))})})):(a.fullname=b.body.fullname,a.email=b.body.email,a.position=b.body.position,a.status=b.body.status,a.role=b.body.role,a.file=c,a.save().then(f=>{b.flash("success_msg",`${f.fullname} has been updated successfully`);d.redirect("/admin/users")}).catch(f=>console.log(f)))})});
router.delete("/delete/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{""!=a.file&&"default.png"!=a.file&&fs.unlink("./public/uploads/"+a.file,c=>{c&&console.log(c)});a.delete().then(c=>{b.flash("success_msg",`${c.fullname} has been deleted successfully`);d.redirect("/admin/users")}).catch(c=>console.log(c))})});module.exports=router;s=router;