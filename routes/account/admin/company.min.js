'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../../models/Company"),User=require("../../../models/User"),Rating=require("../../../models/Rating"),faker=require("faker"),fs=require("fs"),{isEmpty}=require("../../../helpers/upload-helpers");router.all("/*",(b,d,a)=>{b.app.locals.layout="admin";a()});router.get("/",(b,d)=>{Company.find().then(a=>{d.render("accounts/admin/company",{title:"Admin|Company",companies:a})}).catch(a=>console.log(a))});
router.get("/subscribers_view",(b,d)=>{Company.find().then(a=>{d.render("accounts/admin/company/subscribers_company_views",{title:"Companies|nodeRatings",companies:a})}).catch(a=>console.log(a))});router.get("/leaderboard",(b,d)=>{Company.find().sort({ratingSum:-1}).then(a=>{d.render("accounts/admin/company/leaderboard",{title:"Leaderboard|nodeRatings",companies:a})}).catch(a=>console.log(a))});router.get("/create",(b,d)=>{d.render("accounts/admin/company/create",{title:"Company|Create"})});
router.get("/dummy",(b,d)=>{"Manager"!==b.user.role&&(b.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/admin/company"));d.render("accounts/admin/company/dummy",{title:"company|Dummy"})});router.get("/edit/:id",(b,d)=>{Company.findOne({_id:b.params.id}).then(a=>{d.render("accounts/admin/company/edit",{title:"Company|Edit",company:a})}).catch(a=>console.log(a))});
router.get("/show/:id",(b,d)=>{Company.findOne({_id:b.params.id}).populate("user").then(a=>{Rating.find({company:b.params.id}).populate("user").populate("company").then(c=>{let e=Object.keys(c).length;d.render("accounts/admin/company/show",{title:`${a.name}`,company:a,ratings:c,ratingCount:e,averageRating:parseFloat(a.ratingSum/a.ratingNumber,1)})}).catch(c=>console.log(c))}).catch(a=>console.log(a))});router.get("/search",(b,d)=>{d.render("home/search",{title:"Search|nodeRatings"})});
router.post("/search",(b,d)=>{let a=new RegExp(b.body.search,"i");Company.find({$or:[{name:a}]}).then(c=>{1<c.length?d.render("accounts/admin/company/subscribers_company_views",{title:"Searched|nodeRatings",companies:c}):Company.findOne({$or:[{name:a}]}).populate("user").then(e=>{e||(b.flash("error_msg","No company with such name"),d.redirect("/search"));Rating.find({company:e._id}).populate("company").populate("user").then(f=>{let g=Object.keys(f).length;d.render("account/admin/company/show",{title:`${e.name}`,
company:e,ratings:f,ratingCount:g,averageRating:parseFloat(e.ratingSum/e.ratingNumber,1)})}).catch(f=>console.log(f))}).catch(e=>console.log(e))}).catch(c=>console.log(c))});
router.post("/create",(b,d)=>{let a="";if(!isEmpty(b.files)){const e=b.files.file;a=Date.now()+"-"+e.name;e.mv("./public/uploads/"+a,f=>{f&&console.log(f)})}const c=new Company;c.name=b.body.name;c.address=b.body.address;c.city=b.body.city;c.country=b.body.country;c.sector=b.body.sector;c.website=b.body.website;c.file=a;c.user.push(b.user);c.save().then(e=>{User.findOne({_id:b.user}).then(f=>{f.company=c;f.save().then(g=>{b.flash("success_msg","Company registered successfully");d.redirect("/admin/company")}).catch(g=>
console.log(g))}).catch(f=>console.log(f))}).catch(e=>console.log(e))});
router.post("/dummy",(b,d)=>{"Manager"!==b.user.role&&(b.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/admin/company"));for(let a=0;a<b.body.number;a++){const c=new Company;c.name=faker.lorem.word()+""+faker.random.word();c.address=faker.random.word()+" Avenue";c.sector=faker.random.word();c.website="www."+faker.random.word()+".com";c.country="Country";c.city="City";c.file="img_place.png";c.user.push(b.user);c.save().then(e=>{b.flash("success_msg",`${b.body.number} dummy companies created :)`);
d.redirect("/admin/company")}).catch(e=>console.log(e))}});
router.put("/update/:id",(b,d)=>{Company.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){const e=b.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"img_place.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(f)})}a.name=b.body.name;a.address=b.body.address;a.city=b.body.city;a.country=b.body.country;a.sector=b.body.sector;a.website=b.body.website;a.file=c;a.save().then(e=>{b.flash("success_msg",`${e.name} has been updated :)`);
d.redirect("/admin/company")}).catch(e=>console.log(e))}).catch(a=>console.log(a))});
router.delete("/delete/:id",(b,d)=>{Company.findOne({_id:b.params.id}).then(a=>{"img_place.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{c&&console.log(c)});User.find({company:a.id}).then(c=>{c.company="";c.save().then(e=>{console.log(`Removed all users that had ${a.name} ):`)}).catch(e=>console.log(e))});a.delete().then(c=>{b.flash("success_msg",`${c.name} has been deleted :)`)}).catch(c=>console.log(c))}).catch(a=>console.log(a))});module.exports=router;