'use strict';const express=require("express"),app=express(),router=express.Router(),User=require("../../../models/User"),Company=require("../../../models/Company"),fs=require("fs"),bcrypt=require("bcryptjs"),{isEmpty}=require("../../../helpers/upload-helpers"),{userAuth}=require("../../../helpers/authenticate");router.all("/*",(b,d,a)=>{b.app.locals.layout="user";a()});
router.get("/",(b,d)=>{User.findOne({_id:b.user.id}).populate("company").then(a=>{d.render("accounts/user/profile",{title:"Profile|User",profile:a})}).catch(a=>console.log(a))});router.get("/edit/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{Company.find().then(c=>{d.render("accounts/user/profile/edit",{title:"Edit|Profile",profile:a,companies:c})}).catch(c=>console.log(c))}).catch(a=>console.log(a))});
router.get("/edit/:id/company/:comp_id",(b,d)=>{User.findOne({_id:b.params.id}).populate("company").then(a=>{Company.findOne({_id:b.params.comp_id}).populate("company").then(c=>{d.render("accounts/user/profile/edit",{title:"Edit|Profile",profile:a,company:c})}).catch(c=>console.log(c))}).catch(a=>console.log(a))});
router.put("/:id/update",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){var f=b.files.file;c=Date.now()+"-"+f.name;f.mv("./public/uploads/"+c,e=>{e&&console.log(e)});""!==a.file&&"default.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,e=>{e&&console.log(e)})}f=a.company;b.body.company&&(f=b.body.company);b.body.password?(a.fullname=b.body.fullname,a.email=b.body.email,a.phone=b.body.phone,a.company=f,a.file=c,bcrypt.genSalt(10,(e,k)=>{bcrypt.hash(b.body.password,
k,(g,l)=>{g&&console.log(g);a.password=l.then(h=>{b.flash("success_msg","Profile updated :)");d.redirect("/user/profile")}).catch(h=>console.log(h))})})):(a.fullname=b.body.fullname,a.email=b.body.email,a.phone=b.body.phone,a.company=f,a.file=c,a.save().then(e=>{b.flash("success_msg","Profile updated :)");d.redirect("/user/profile")}).catch(e=>console.log(e)))}).catch(a=>console.log(a))});module.exports=router;