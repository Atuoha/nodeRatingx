'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../../models/Company"),User=require("../../../models/User"),faker=require("faker"),fs=require("fs"),{isEmpty}=require("../../../helpers/upload-helpers");router.all("/*",(a,d,b)=>{a.app.locals.layout="user";b()});router.get("/",(a,d)=>{Company.find().then(b=>{d.render("accounts/user/company",{title:"User|Company",companies:b})}).catch(b=>console.log(b))});
router.get("/subscribers_view",(a,d)=>{Company.find().then(b=>{d.render("accounts/user/company/subscribers_company_view",{title:"Companies|nodeRatings",companies:b})}).catch(b=>console.log(b))});
router.get("/create",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({user:a.user}).then(b=>{b&&(a.flash("error_msg","Opps! You already manage a company. A manager can only manage one Company with a single account..."),d.redirect("/user/company"))});d.render("accounts/user/company/create",{title:"Company|Create"})});
router.get("/dummy",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));d.render("accounts/user/company/dummy",{title:"company|Dummy"})});
router.get("/edit/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{Company.findOne({user:a.user}).then(c=>{c||(a.flash("error_msg","Access Denied! You can only edit companies you created ):"),d.redirect("/user/company"))}).catch(c=>console.log(c));d.render("accounts/user/company/edit",{title:"Company|Edit",company:b})}).catch(b=>console.log(b))});
router.get("/show/:id",(a,d)=>{Company.findOne({_id:a.params.id}).populate("user").then(b=>{d.render("accounts/user/company/show",{title:"Company|Show",company:b})}).catch(b=>console.log(b))});
router.post("/create",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({name:a.body.name}).then(b=>{if(b)a.flash("error_msg","Company Already Exists..."),d.redirect("/user/company");else{b="";if(!isEmpty(a.files)){var c=a.files.file;b=Date.now()+"-"+c.name;c.mv("./public/uploads/"+b,e=>{e&&console.log(e)})}c=new Company;c.name=a.body.name;c.address=a.body.address;c.city=a.body.city;c.country=
a.body.country;c.sector=a.body.sector;c.website=a.body.website;c.file=b;c.user.push(a.user);c.save().then(e=>{a.flash("success_msg","Company registered successfully");d.redirect("/user/company")}).catch(e=>console.log(e))}}).catch(b=>console.log(b))});
router.post("/dummy",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));for(let b=0;b<a.body.number;b++){const c=new Company;c.name=faker.lorem.word()+""+faker.random.word();c.address=faker.random.word()+" Avenue";c.sector=faker.random.word();c.website="www."+faker.random.word()+".com";c.country="Country";c.city="City";c.file="img_place.png";c.user.push(a.user);c.save().then(e=>{a.flash("success_msg",`${a.body.number} dummy companies created :)`);
d.redirect("/user/company")}).catch(e=>console.log(e))}});
router.put("/update/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{b.user!=a.user.id&&(a.flash("error_msg","Access Denied! You can only edit companies you created ):"),d.redirect("/user/company"));let c=b.file;if(!isEmpty(a.files)){const e=a.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"img_place.png"!==b.file&&
""!==b.file&&fs.unlink("./public/uploads/"+b.file,f=>{f&&console.log(f)})}b.name=a.body.name;b.address=a.body.address;b.city=a.body.city;b.country=a.body.country;b.sector=a.body.sector;b.website=a.body.website;b.file=c;b.save().then(e=>{a.flash("success_msg",`${e.name} has been updated :)`);d.redirect("/user/company")}).catch(e=>console.log(e))}).catch(b=>console.log(b))});
router.delete("/delete/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{b.user!=a.user.id?(a.flash("error_msg","Access Denied! You can only delete companies you created ):"),d.redirect("/user/company")):"img_place.png"!==b.file&&""!==b.file&&fs.unlink("./public/uploads/"+b.file,c=>{c&&console.log(c)});User.find({company:b.id}).then(c=>{c.company="";c.save().then(e=>
{console.log(`Removed all users that had ${b.name} ):`)}).catch(e=>console.log(e))});b.delete().then(c=>{a.flash("success_msg",`${c.name} has been deleted :)`)}).catch(c=>console.log(c))}).catch(b=>console.log(b))});module.exports=router;