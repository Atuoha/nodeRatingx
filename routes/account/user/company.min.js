'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../../models/Company"),User=require("../../../models/User"),Rating=require("../../../models/Rating"),faker=require("faker"),fs=require("fs"),{isEmpty}=require("../../../helpers/upload-helpers"),{userAuth}=require("../../../helpers/authenticate");router.all("/*",(a,d,b)=>{a.app.locals.layout="user";b()});
router.get("/",(a,d)=>{Company.find().then(b=>{d.render("accounts/user/company",{title:"User|Company",companies:b})}).catch(b=>console.log(b))});router.get("/subscribers_view",(a,d)=>{Company.find().then(b=>{d.render("accounts/user/company/subscribers_company_views",{title:"Companies|nodeRatings",companies:b})}).catch(b=>console.log(b))});
router.get("/leaderboard",(a,d)=>{Company.find().sort({ratingSum:-1}).then(b=>{d.render("accounts/user/company/leaderboard",{title:"Leaderboard|nodeRatings",companies:b})}).catch(b=>console.log(b))});
router.get("/create",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({user:a.user}).then(b=>{b&&(a.flash("error_msg","Opps! You already manage a company. A manager can only manage one Company with a single account..."),d.redirect("/user/company"))});d.render("accounts/user/company/create",{title:"Company|Create"})});
router.get("/dummy",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));d.render("accounts/user/company/dummy",{title:"company|Dummy"})});
router.get("/edit/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{for(let c=0;c<b.user.length;c++)b.user[c]==a.user.id?(console.log("recognised"),d.render("accounts/user/company/edit",{title:"Company|Edit",company:b})):(console.log("not recognised"),a.flash("error_msg","Access Denied! You can only edit companies you created ):"),d.redirect("/user/company"))}).catch(b=>
console.log(b))});router.get("/show/:id",(a,d)=>{Company.findOne({_id:a.params.id}).populate("user").then(b=>{Rating.find({company:a.params.id}).populate("user").populate("company").then(c=>{let e=Object.keys(c).length;d.render("accounts/user/company/show",{title:`${b.name}`,company:b,ratings:c,ratingCount:e,averageRating:parseFloat(b.ratingSum/b.ratingNumber,1)})}).catch(c=>console.log(c))}).catch(b=>console.log(b))});router.get("/search",(a,d)=>{d.render("home/search",{title:"Search|nodeRatings"})});
router.post("/search",(a,d)=>{let b=new RegExp(a.body.search,"i");Company.find({$or:[{name:b}]}).then(c=>{1<c.length?d.render("accounts/user/company/subscribers_company_views",{title:"Searched|nodeRatings",companies:c}):Company.findOne({$or:[{name:b}]}).populate("user").then(e=>{e||(a.flash("error_msg","No company with such name"),d.redirect("/search"));Rating.find({company:e._id}).populate("company").populate("user").then(f=>{let g=Object.keys(f).length;d.render("account/user/company/show",{title:`${e.name}`,
company:e,ratings:f,ratingCount:g,averageRating:parseFloat(e.ratingSum/e.ratingNumber,1)})}).catch(f=>console.log(f))}).catch(e=>console.log(e))}).catch(c=>console.log(c))});
router.post("/create",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({name:a.body.name}).then(b=>{if(b)a.flash("error_msg","Company Already Exists..."),d.redirect("/user/company");else{b="";if(!isEmpty(a.files)){const e=a.files.file;b=Date.now()+"-"+e.name;e.mv("./public/uploads/"+b,f=>{f&&console.log(f)})}const c=new Company;c.name=a.body.name;c.address=a.body.address;c.city=a.body.city;
c.country=a.body.country;c.sector=a.body.sector;c.website=a.body.website;c.file=b;c.user.push(a.user);c.save().then(e=>{User.findOne({_id:a.user}).then(f=>{f.company=c;f.save().then(g=>{a.flash("success_msg","Company registered successfully");d.redirect("/user/company")}).catch(g=>console.log(g))}).catch(f=>console.log(f))}).catch(e=>console.log(e))}}).catch(b=>console.log(b))});
router.post("/dummy",(a,d)=>{"Admin"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));for(let b=0;b<a.body.number;b++){const c=new Company;c.name=faker.lorem.word()+""+faker.random.word();c.address=faker.random.word()+" Avenue";c.sector=faker.random.word();c.website="www."+faker.random.word()+".com";c.country="Country";c.city="City";c.file="img_place.png";c.user.push(a.user);c.save().then(e=>{a.flash("success_msg",`${a.body.number} dummy companies created :)`);
d.redirect("/user/company")}).catch(e=>console.log(e))}});
router.put("/update/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{for(let c=0;c<=b.user.length;c++)if(b.user[c]==a.user.id){console.log("recognised");let e=b.file;if(!isEmpty(a.files)){const f=a.files.file;e=Date.now()+"-"+f.name;f.mv("./public/uploads/"+e,g=>{g&&console.log(g)});"img_place.png"!==b.file&&""!==b.file&&fs.unlink("./public/uploads/"+b.file,
g=>{g&&console.log(g)})}b.name=a.body.name;b.address=a.body.address;b.city=a.body.city;b.country=a.body.country;b.sector=a.body.sector;b.website=a.body.website;b.file=e;b.save().then(f=>{a.flash("success_msg",`${f.name} has been updated :)`);d.redirect("/user/company")}).catch(f=>console.log(f))}else console.log("not recognised"),a.flash("error_msg","Access Denied! You can only edit companies you created ):"),d.redirect("/user/company")}).catch(b=>console.log(b))});
router.delete("/delete/:id",(a,d)=>{"Manager"!==a.user.role&&(a.flash("error_msg","Access Denied! Action requires managerial certifications ):"),d.redirect("/user/company"));Company.findOne({_id:a.params.id}).then(b=>{for(let c=0;c<=b.user.length;c++)b.user[c]==a.user.id?(console.log("recognised"),"img_place.png"!==b.file&&""!==b.file&&fs.unlink("./public/uploads/"+b.file,e=>{e&&console.log(e)}),User.find({company:b.id}).then(e=>{e.company="";e.save().then(f=>{console.log(`Removed all users that had ${b.name} ):`)}).catch(f=>
console.log(f))}),b.delete().then(e=>{a.flash("success_msg",`${e.name} has been deleted :)`)}).catch(e=>console.log(e))):(console.log("not recognised"),a.flash("error_msg","Access Denied! You can only edit companies you created ):"),d.redirect("/user/company"))}).catch(b=>console.log(b))});module.exports=router;