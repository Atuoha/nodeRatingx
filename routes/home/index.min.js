'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../models/Company"),Rating=require("../../models/Rating");router.all("/*",(d,b,a)=>{d.app.locals.layout="home";a()});router.get("/",(d,b)=>{null!=d.session.cookie.originalMaxAge?b.redirect("/admin"):b.render("home/index",{title:"nodeRatingx|Home"})});
router.get("/company",(d,b)=>{const a=d.query.page||1;Company.find().skip(5*a-5).limit(5).then(e=>{Company.countDocuments().then(c=>{b.render("home/company",{title:"Companies|Home",companies:e,current:parseInt(a),pages:Math.ceil(c/5)})}).catch(c=>console.log(c))}).catch(e=>console.log(e))});
router.get("/single_company/:id",(d,b)=>{Company.findOne({_id:d.params.id}).populate("user").then(a=>{Rating.find({company:d.params.id}).populate("company").populate("user").then(e=>{let c=Object.keys(e).length;b.render("home/single_company",{title:`${a.name}`,company:a,ratings:e,ratingCount:c,averageRating:parseFloat(a.ratingSum/a.ratingNumber,1)})}).catch(e=>console.log(e))}).catch(a=>console.log(a))});
router.get("/leaderboard",(d,b)=>{Company.find().sort({ratingSum:-1}).then(a=>{b.render("home/leaderboard",{title:"Leaderboard|nodeRatings",companies:a})}).catch(a=>console.log(a))});router.get("/search",(d,b)=>{b.render("home/search",{title:"Search|nodeRatings"})});
router.post("/search",(d,b)=>{let a=new RegExp(d.body.search,"i");Company.find({$or:[{name:a}]}).then(e=>{1<e.length?b.render("home/company",{title:"Searched|nodeRatings",companies:e}):Company.findOne({$or:[{name:a}]}).populate("user").then(c=>{c||(d.flash("error_msg","No company with such name"),b.redirect("/search"));Rating.find({company:c._id}).populate("company").populate("user").then(f=>{let g=Object.keys(f).length;b.render("home/single_company",{title:`${c.name}`,company:c,ratings:f,ratingCount:g,
averageRating:parseFloat(c.ratingSum/c.ratingNumber,1)})}).catch(f=>console.log(f))}).catch(c=>console.log(c))}).catch(e=>console.log(e))});module.exports=router;