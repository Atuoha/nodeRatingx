'use strict';const express=require("express"),app=express(),router=express.Router(),Company=require("../../models/Company"),Rating=require("../../models/Rating");router.all("/*",(c,b,a)=>{c.app.locals.layout="home";a()});router.get("/",(c,b)=>{null!=c.session.cookie.originalMaxAge?b.redirect("/admin"):b.render("home/index",{title:"nodeRatingx|Home"})});
router.get("/company",(c,b)=>{const a=c.query.page||1;Company.find().skip(5*a-5).limit(5).then(d=>{Company.countDocuments().then(e=>{b.render("home/company",{title:"Companies|Home",companies:d,current:parseInt(a),pages:Math.ceil(e/5)})}).catch(e=>console.log(e))}).catch(d=>console.log(d))});
router.get("/single_company/:id",(c,b)=>{Company.findOne({_id:c.params.id}).populate("user").then(a=>{Rating.find({company:c.params.id}).populate("company").populate("user").then(d=>{let e=Object.keys(d).length;b.render("home/single_company",{title:`${a.name}`,company:a,ratings:d,ratingCount:e,averageRating:parseFloat(a.ratingSum/a.ratingNumber,1)})}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.get("/leaderboard",(c,b)=>{Company.find().sort({ratingSum:-1}).then(a=>{b.render("home/leaderboard",{title:"Leaderboard|nodeRatings",companies:a})}).catch(a=>console.log(a))});router.get("/search",(c,b)=>{b.render("home/search",{title:"Search|nodeRatings"})});
router.post("/search",(c,b)=>{let a=new RegExp(c.body.search,"i");Company.find({$or:[{name:a}]}).then(d=>{1<d.length?b.render("home/company",{title:"Searched|nodeRatings",companies:d}):Company.findOne({$or:[{name:a}]}).populate("user").then(e=>{e||(c.flash("error_msg","No company with such name"),b.redirect("/search"));Rating.find({company:c.params.id}).populate("company").populate("user").then(f=>{let g=Object.keys(f).length;b.render("home/single_company",{title:`${e.name}`,company:e,ratings:f,ratingCount:g,
averageRating:parseFloat(e.ratingSum/e.ratingNumber,1)})}).catch(f=>console.log(f))}).catch(e=>console.log(e))}).catch(d=>console.log(d))});module.exports=router;